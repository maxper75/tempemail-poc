<!DOCTYPE html>

<html>

<head>
	<meta charset="UTF-8">
	<title>Prova Jquery</title>
	<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
	<script type="text/javascript" src="/tempemail/seam/resource/restv1/tempemail/js-api"></script>
	
	<link rel="stylesheet" href="/tempemail/fancybox/source/jquery.fancybox.css" type="text/css" media="screen" />
	<script type="text/javascript" src="/tempemail/fancybox/source/jquery.fancybox.js"></script>
	
	<script type="text/javascript">
		var refreshIntervalId;
		var msize=0;
		
				
		$(document).ready(function()	{

			$("#create").click(create);
//			$("#create").click(function()	{
//				var indirizzo=$("#indirizzo").val();
//				var res;
//				if(indirizzo.length>0)	
//					res=TempEmailRestServices.createEmail({username:indirizzo});
//				else	res=TempEmailRestServices.createRandomEmail();
//					if(res=="non rispetta la sintassi")	{
//						$("#error").text("nome utente non rispetta la sintassi!");
//						$("#indirizzo").val("");
//						return;
//					}
//					else if(res=="gia presente in database")	{
//							$("#error").text("nome utente gia utilizzato da altri!");
//							$("#indirizzo").val("");
//							return;
//						}
//						else if(res=="utente gia in sessione")	{
//							$("#error").text("nome utente gia creato: "+TempEmailRestServices.getNomeUtente());
//							$("#indirizzo").val("");
//						}
//						else	{ 
//							$("#error").text("nome utente: "+TempEmailRestServices.getNomeUtente());
//							$("#indirizzo").val(res);
//						}
				
//				$("#create").hide();
//				$("#addressfield").hide();
//				$("#refresh").show();
//				$("#delete").show();
//				$("#expire").show();
			
//				refreshIntervalId=setInterval(function()	{
					
//					var status=TempEmailRestServices.getMailboxStatus();
					//COUNTDOWN IN MIN/SEC
//					var countdown="scadenza: "+Math.floor(status.countdown/60)+" min "+(status.countdown%60)+" sec";
//					$("#timer").text(countdown);
					//$("#timer").text(status.countdown);	
//					$("#msize").text("mail: "+status.mailboxsize);
//					if(status.countdown<=0)	{
//						del();
////						clearInterval(refreshIntervalId);
////						var table=document.getElementById("maillist");
////						for(var i=msize;i>0;i--)	
////							table.deleteRow(i);
////						$("#div1").hide();
////						$("#timer").text("");
////						$("#msize").text("");
////						$("#indirizzo").val("");
////						$("#error").text("");
////						$("#create").show();
////						$("#refresh").hide();
////						$("#delete").hide();
////						$("#expire").hide();
////						$("#addressfield").show();
////						msize=0;
////						TempEmailRestServices.deleteEmail();
//						return;	
//					}

//					if(status.mailboxsize!=msize)	{
						//visibilità tabella
//						$("#div1").show();
						//riempimento tabella
//						var container=TempEmailRestServices.getMessageHeaders();
//						var listMess=container.aaData;
//						var table=document.getElementById("maillist");


						//aggiunge i nuovi messaggi in cima alla table
//						for(var i=msize;i<listMess.length;i++)	{

//							var row = table.insertRow(1);
//							var mess=listMess[i];
//							var cell1 = row.insertCell(0);
//							var cell2 = row.insertCell(1);
//							var cell3 = row.insertCell(2);
//							var cell4 = row.insertCell(3);
//							var cell5 = row.insertCell(4);
//							cell5.className="MessageId";
//							cell5.style.display="none";
//							cell1.innerHTML = mess.from;
//							cell2.innerHTML = mess.to;
//							cell3.innerHTML = mess.subject;
//							cell4.innerHTML = mess.received;
//							cell5.innerHTML = mess.messageId;

//							$("#maillist tr:eq(1)").click(getBody);
							
////							$("#maillist tr:eq(1)").click(function()	{
////								   var valore=$(this).find(".MessageId").html();
////								   var completeMessage=TempEmailRestServices.getCompleteMessage({messageid:valore});
////								   $("#example").text(completeMessage.body);
////								   $.fancybox(	{href: "#example"});
////							});

//						}
						
						
//						$("tr:even").css("background-color", "#2B60DE");
//						$("tr:odd").css("background-color", "#0000A0");
//						$("tr").css("color", "yellow");
						
						
//					}
//					msize=status.mailboxsize;

					

					
//				},2000);
//			});	
						
			
			$("#refresh").click(refresh);
			
//			$("#refresh").click(function()	{
				//COUNTDOWN IN MIN/SEC
//				var refr=TempEmailRestServices.refreshing();
//				$("#timer").text("scadenza: "+Math.floor(refr/60)+" min "+(refr%60)+" sec");
				//$("#timer").text(TempEmailRestServices.refreshing());
//			});

			$("#expire").click(expire);
			
//			$("#expire").click(function()	{
				//COUNTDOWN IN MIN/SEC
//				var refr=TempEmailRestServices.getExpireTime();
//				$("#timer").text("scadenza: "+Math.floor(refr/60)+" min "+(refr%60)+" sec");
				//$("#timer").text(TempEmailRestServices.getExpireTime());
//			});

			$("#delete").click(del);
			
//			$("#delete").click(function()	{
//				clearInterval(refreshIntervalId);
//				var table=document.getElementById("maillist");
//				for(var i=msize;i>0;i--)	
//					table.deleteRow(i);
//				msize=0;
//				$("#div1").hide();
//				$("#timer").text("");
//				$("#msize").text("");
//				$("#error").text("");
//				$("#indirizzo").val("");
//				TempEmailRestServices.deleteEmail();
//				$("#create").show();
//				$("#addressfield").show();
//				$("#refresh").hide();
//				$("#delete").hide();
//				$("#expire").hide();
//			});

//carica l'utente in sessione se è già presente			
			if(TempEmailRestServices.getNomeUtente()!="non presente")	{	
				//$("#create").click();
				create();
				intervaller();
			}
	});
	//CREATE
	
	function create()	{
		var indirizzo=$("#indirizzo").val();
		var res;
		if(indirizzo.length>0)	
			res=TempEmailRestServices.createEmail({username:indirizzo});
		else	res=TempEmailRestServices.createRandomEmail();
		if(res=="non rispetta la sintassi")	{
			$("#error").text("nome utente non rispetta la sintassi!");
			$("#indirizzo").val("");
			return;
		}
		else if(res=="gia presente in database")	{
				$("#error").text("nome utente gia utilizzato da altri!");
				$("#indirizzo").val("");
				return;
			}
			else if(res=="utente gia in sessione")	{
					$("#error").text("nome utente gia creato: "+TempEmailRestServices.getNomeUtente());
					$("#indirizzo").val("");
				}
				else	{ 
					$("#error").text("nome utente: "+TempEmailRestServices.getNomeUtente());
					$("#indirizzo").val(res);
				}
				
		$("#create").hide();
		$("#addressfield").hide();
		$("#refresh").show();
		$("#delete").show();
		$("#expire").show();
			
		refreshIntervalId=setInterval(intervaller,2000);
	};
	
	function intervaller()	{
		var status=TempEmailRestServices.getMailboxStatus();
		//COUNTDOWN IN MIN/SEC
		var countdown="scadenza: "+Math.floor(status.countdown/60)+" min "+(status.countdown%60)+" sec";
		$("#timer").text(countdown);
		//$("#timer").text(status.countdown);	
		$("#msize").text("mail: "+status.mailboxsize);
		if(status.countdown<=0)	{
			del();
			return;	
		}
		if(status.mailboxsize!=msize)	{
			//visibilità tabella
			$("#div1").show();
			//riempimento tabella
			var container=TempEmailRestServices.getMessageHeaders();
			var listMess=container.aaData;
			var table=document.getElementById("maillist");
			//aggiunge i nuovi messaggi in cima alla table
			for(var i=msize;i<listMess.length;i++)	{
				var row = table.insertRow(1);
				var mess=listMess[i];
				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				var cell3 = row.insertCell(2);
				var cell4 = row.insertCell(3);
				var cell5 = row.insertCell(4);
				cell5.className="MessageId";
				cell5.style.display="none";
				cell1.innerHTML = mess.from;
				cell2.innerHTML = mess.to;
				cell3.innerHTML = mess.subject;
				cell4.innerHTML = mess.received;
				cell5.innerHTML = mess.messageId;
				$("#maillist tr:eq(1)").click(getBody);
			}
			$("tr:even").css("background-color", "#2B60DE");
			$("tr:odd").css("background-color", "#0000A0");
			$("tr").css("color", "yellow");
		}
		msize=status.mailboxsize;
	};
	
	function getBody()	{
	   var valore=$(this).find(".MessageId").html();
	   var completeMessage=TempEmailRestServices.getCompleteMessage({messageid:valore});
	   $("#example").text(completeMessage.body);
	   $.fancybox(	{href: "#example"});
	};
		
	function refresh()	{
		//COUNTDOWN IN MIN/SEC
		var refr=TempEmailRestServices.refreshing();
		$("#timer").text("scadenza: "+Math.floor(refr/60)+" min "+(refr%60)+" sec");
	};
		
	function expire()	{
		//COUNTDOWN IN MIN/SEC
		var refr=TempEmailRestServices.getExpireTime();
		$("#timer").text("scadenza: "+Math.floor(refr/60)+" min "+(refr%60)+" sec");
	};
		
	function del()	{
		clearInterval(refreshIntervalId);
		var table=document.getElementById("maillist");
		for(var i=msize;i>0;i--)	
			table.deleteRow(i);
		msize=0;
		$("#div1").hide();
		$("#timer").text("");
		$("#msize").text("");
		$("#error").text("");
		$("#indirizzo").val("");
		TempEmailRestServices.deleteEmail();
		$("#create").show();
		$("#addressfield").show();
		$("#refresh").hide();
		$("#delete").hide();
		$("#expire").hide();
		$("#error").text("utente eliminato!");	
	};
		
	</script>
</head>

<body>
	<div id="error"></div>
	<div id="addressfield">
	<input type="text" name="indirizzo" id="indirizzo"/>@pippopluto.com
	</div>
	<div id="timer"></div>
	<div id="msize"></div>
	<button id="create">click to create</button>
	<button id="refresh" style="display:none">click to refresh</button>
	<button id="delete" style="display:none">click to delete</button>
	<button id="expire" style="display:none">click to update countdown</button>
	<div id="div1" style="display:none">
	<table style="width:100%;" id="maillist" border="3" bordercolor="yellow" >
		<thead>
			<tr>
				<th>From</th>
				<th>To</th>
				<th>Subject</th>
				<th>Date</th>
				<th class="MessageId" style="display:none">MessageId</th>
			</tr>
		</thead>
		<tbody>
			
		</tbody>
	</table>
	</div>

	
	<div id="example"></div> 

</body>

</html>