<!DOCTYPE html>

<html>

<head>
	<meta charset="UTF-8">
	<title>Prova Jquery V2</title>
	<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
	<script type="text/javascript" src="/tempemail/seam/resource/restv1/tempemail/js-api"></script>
	<link rel="stylesheet" href="/tempemail/fancybox/source/jquery.fancybox.css" type="text/css" media="screen" />
	<script type="text/javascript" src="/tempemail/fancybox/source/jquery.fancybox.js"></script>
	
	<script id="worker1" type="javascript/worker">
		importScripts("http://vm-dbmail.sede.i-node.it:8080/tempemail/seam/resource/restv1/tempemail/js-api");
		function timedCount()	{
			var container=TempEmailRestServices.push();
			postMessage(container);
			setTimeout("timedCount()",500);
		}
		timedCount();
	</script>

	<script type="text/javascript">
		var refreshIntervalId;
		var msize=0;
		var blob=new Blob([document.querySelector('#worker1').textContent]);
		var worker;//= new Worker(window.URL.createObjectURL(blob));
		//commento	
		$(document).ready(function()	{
		
			//var blob=new Blob([document.querySelector('#worker1').textContent]);
			//var worker = new Worker(window.URL.createObjectURL(blob));
			//worker.onmessage = function (event)	{
			//	var container=event.data;
			//	document.getElementById("error").innerHTML = event.data;
			//	if(event.data==50)
			//		worker.terminate();
			//};
			
			$("#create").click(create);
			$("#refresh").click(refresh);
			$("#expire").click(expire);
			$("#delete").click(del);
			$("#createalias").click(createAlias);
			
			if(TempEmailRestServices.getNomeUtente()!="non presente")	{	
				create();
				intervaller();
			}
	});
	
	function create()	{
		var indirizzo=$("#indirizzo").val();
		var res;
		if(indirizzo.length>0)	
			res=TempEmailRestServices.createEmail({username:indirizzo});
		else	res=TempEmailRestServices.createRandomEmail();
		if(res=="non rispetta la sintassi")	{
			$("#error").text("nome utente non rispetta la sintassi!");
			$("#indirizzo").val("");
			return;
		}
		else if(res=="gia presente in database")	{
				$("#error").text("nome utente gia utilizzato da altri!");
				$("#indirizzo").val("");
				return;
			}
			else if(res=="utente gia in sessione")	{
					$("#error").text("nome utente gia creato: "+TempEmailRestServices.getNomeUtente());
					$("#indirizzo").val("");
				}
				else	{ 
					$("#error").text("nome utente: "+TempEmailRestServices.getNomeUtente());
					$("#indirizzo").val(res);
				}
		$("#create").hide();
		$("#addressfield").hide();
		$("#refresh").show();
		$("#div2").show();
		$("#delete").show();
		$("#expire").show();
		$("#alias").show();
		$("#createalias").show();
		intervaller();
		//refreshIntervalId=setInterval(intervaller,2000);		
		setTimeout(pusher,1000);
	};

	function pusher()	{
		//inserimento worker
		worker = new Worker(window.URL.createObjectURL(blob));
		worker.onmessage = function (event)	{
			var container=event.data;
			if(container.aaData[0]!=null)	{
				//$("#div1").show();
				var listMess=container.aaData;
				var table=document.getElementById("maillist");
				for(var i=0;i<listMess.length;i++)	{
					var mess=listMess[i];
					insNewRow(mess);
					msize++;
				}
				$("tr:even").css("background-color", "#2B60DE");
				$("tr:odd").css("background-color", "#0000A0");
				$("tr").css("color", "yellow");
			}
			intervaller();
		};
	}
	
	function intervaller()	{
		var status=TempEmailRestServices.getMailboxStatus();
		//COUNTDOWN IN MIN/SEC
		var countdown="scadenza: "+Math.floor(status.countdown/60)+" min "+(status.countdown%60)+" sec";
		$("#timer").text(countdown);
		$("#msize").text("mail: "+status.mailboxsize);
		if(status.countdown<=0)	{
			del();
			return;	
		}
		if(status.mailboxsize!=msize)	{
			var container=TempEmailRestServices.getMessageHeaders();
			clearTable();

			var listMess=container.aaData;
			for(var i=0;i<listMess.length;i++)	{
				var mess=listMess[i];
				insNewRow(mess);
			}
			$("tr:even").css("background-color", "#2B60DE");
			$("tr:odd").css("background-color", "#0000A0");
			$("tr").css("color", "yellow");
			msize=status.mailboxsize;
		}
		if (msize!=0)
			$("#div1").show();
	};

	function insNewRow(mess)	{
		var table=document.getElementById("maillist");
		var row = table.insertRow(1);
		var cell1 = row.insertCell(0);
		var cell2 = row.insertCell(1);
		var cell3 = row.insertCell(2);
		var cell4 = row.insertCell(3);
		var cell5 = row.insertCell(4);
		cell5.className="MessageId";
		cell5.style.display="none";
		cell1.innerHTML = mess.from;
		cell2.innerHTML = mess.to;
		cell3.innerHTML = mess.subject;
		cell4.innerHTML = mess.received;
		cell5.innerHTML = mess.messageId;
		$("#maillist tr:eq(1)").click(getBody);
	}
	
	function getBody()	{
	   var valore=$(this).find(".MessageId").html();
	   var completeMessage=TempEmailRestServices.getCompleteMessage({messageid:valore});
	   $("#example").text(completeMessage.body);
	   $.fancybox(	{href: "#example"});
	};
		
	function refresh()	{
		//COUNTDOWN IN MIN/SEC
		var refr=TempEmailRestServices.refreshing();
		$("#timer").text("scadenza: "+Math.floor(refr/60)+" min "+(refr%60)+" sec");
	};
		
	function expire()	{
		//COUNTDOWN IN MIN/SEC
		var refr=TempEmailRestServices.getExpireTime();
		$("#timer").text("scadenza: "+Math.floor(refr/60)+" min "+(refr%60)+" sec");
	};

	function clearTable()	{
		$("#div1").hide();
		var table=document.getElementById("maillist");
		for(var i=msize;i>0;i--)	
			table.deleteRow(i);
		msize=0;
	}
	
	function del()	{
		worker.terminate();
		clearInterval(refreshIntervalId);
		clearTable();
		$("#timer").text("");
		$("#msize").text("");
		$("#indirizzo").val("");
		TempEmailRestServices.deleteEmail();
		$("#create").show();
		$("#addressfield").show();
		$("#refresh").hide();
		$("#delete").hide();
		$("#expire").hide();
		$("#div2").hide();
		$("#alias").val("");
		$("#output").text("inserisci qui la tua mail per ricevere le mail li!");
		$("#error").text("utente eliminato!");	
	};

	function createAlias()	{
		var indirizzo=$("#alias").val();
		if(indirizzo.length>0)	{
			var res=TempEmailRestServices.createAlias({alias:indirizzo});
			$("#output").text(res);
			$("#alias").hide();
			$("#createalias").hide();
		}
		else $("#output").text("inserisci un alias valido!");
	}
	
	</script>
</head>

<body>
	<div id="error"></div>
	<div id="addressfield">
		<input type="text" name="indirizzo" id="indirizzo"/>@pippopluto.com
	</div>
	<div id="timer"></div>
	<div id="msize"></div>
	<button id="create">click to create</button>
	<button id="refresh" style="display:none">click to refresh</button>
	<button id="delete" style="display:none">click to delete</button>
	<button id="expire" style="display:none">click to update countdown</button>
	<div id="div1" style="display:none">
	<table style="width:100%;" id="maillist" border="3" bordercolor="yellow" >
		<thead>
			<tr>
				<th>From</th>
				<th>To</th>
				<th>Subject</th>
				<th>Date</th>
				<th class="MessageId" style="display:none">MessageId</th>
			</tr>
		</thead>
		<tbody>
			
		</tbody>
	</table>
	</div>
	<div id="div2" style="display:none">
		<output id="output">inserisci qui la tua mail per ricevere le mail li!</output><br>
		<input type="text" name="alias" id="alias"/><br>
		<button id="createalias">click to create alias</button>
	</div>
	
	<div id="example"></div> 

</body>

</html>